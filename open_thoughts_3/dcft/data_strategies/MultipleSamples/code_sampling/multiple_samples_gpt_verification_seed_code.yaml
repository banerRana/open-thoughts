operators:
  - id: load_preexisting
    config:
      type: load_preexisting
      framework_name: base_get_difficulty_seed_code
  - id: keep_only_few_columns
    config:
      type: function
      function: data_strategies.commons.keep_only_columns
      function_config:
        columns_to_keep:
          - problem
    input_ids:
      - load_preexisting
  - id: dedup_topics
    config:
      type: function
      function: data_strategies.commons.dedup_on_columns
      function_config:
        dedup_columns:
          - problem
    input_ids:
      - keep_only_few_columns
  - id: sample_dataset
    config:
      type: function
      function: data_strategies.commons.uniform_sample_fixed
      function_config:
        num_samples: 2_500
    input_ids:
      - dedup_topics
  - id: duplicate
    config:
      type: function
      function: data_strategies.TestTime.generator.duplicate_rows
      function_config:
        n_copies: 3
    input_ids:
      - sample_dataset
  - id: annotate
    config:
      type: completions
      map: chat
      map_config:
        user_message_column: problem
        output_column: r1_distill_70b_response
      model: "together_ai/deepseek-ai/DeepSeek-R1-Distill-Llama-70B"
      batch: False
      temperature: 1.0
      backend_params:
        max_requests_per_minute: 250
        max_tokens_per_minute: 500_000
        invalid_finish_reasons: ['content_filter']
      generation_params:
        max_tokens: 32_000
    input_ids:
      - duplicate
  - id: validate_questions
    config:
      type: completions
      model: gpt-4o-mini
      map: binary_classifier
      map_config:
        user_message: |
          Is the provided code snippet a correct solution to the following problem?

          Question: {{problem}}
          Response: {{r1_distill_70b_response}}
        output_column: correct
      temperature: 0.0  # From stage 1
      top_p: 1.0
      presence_penalty: 0.0
    input_ids:
      - annotate
  - id: merge_together
    config:
      type: function
      function: data_strategies.TestTime.generator.merge_duplicate_rows
      function_config:
        diff_columns: 
          - r1_distill_70b_response
          - r1_distill_70b_extracted_answer
          - correct
          - classifier_response
    input_ids:
      - validate_questions
  - id: gpt_verification
    config:
      type: function
      function: data_strategies.MultipleSamples.utils.select_correct_multiple_samples
      function_config:
        response_column: r1_distill_70b_response
        verified_response_column: verified_r1_distill_70b_response
    input_ids:
    - merge_together
  - id: convert_to_sharegpt
    config:
      type: function
      function: data_strategies.commons.convert_instruction_response_to_sharegpt
      function_config:
        input_instruction_column: problem
        input_response_column: verified_r1_distill_70b_response
        output_sharegpt_column: conversations
    input_ids:
      - gpt_verification

  