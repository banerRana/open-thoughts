operators:
  - id: load_scp_data
    config:
      type: hf_source
      dataset: EricLu/SCP-116K
      split: train
  - id: load_unverified_pdf_data
    config:
        type: hf_source
        dataset: mlfoundations-dev/all_filtered_unverified_pdfs_pipeline
        split: train
  - id: load_verified_pdf_data
    config:
      type: hf_source
      dataset: mlfoundations-dev/all_filtered_pdfs_pipeline
      split: train
  - id: load_pdf_data
    config:
      type: mix
    input_ids:
      - load_unverified_pdf_data
      - load_verified_pdf_data
  - id: slim_pdf_data
    config:
      type: function
      function: data_strategies.commons.remove_columns
      function_config:
        columns:
          - page_bytes
          - output_extraction
    input_ids:
      - load_pdf_data
  - id: pdf_altered
    config:
      type: function
      function: data_strategies.commons.force_rename_columns
      function_config:
        column_maps:
          improved_question_solution: detailed_answer
          extracted_solution: matched_solution
    input_ids:
        - slim_pdf_data
  - id: all_data
    config:
      type: mix
    input_ids:
      - load_scp_data
      - pdf_altered
#  - id: all_data
#    config:
#      type: function
#      function: data_strategies.commons.uniform_sample_fixed
#      function_config:
#        num_samples: 2500
#    input_ids:
#      - full_all_data
  - id: organic_chem_questions
    config:
      type: completions
      model: gpt-4o-mini
      map: binary_classifier
      map_config:
        user_message: |
          Yes or No, is this question an organic chemistry question?
          Question:
          {{problem}}
        output_column: is_organic_chemistry
      temperature: 0.0  # From stage 1
      top_p: 1.0
      presence_penalty: 0.0
    input_ids:
      - all_data

  - id: filter_by_organic_chemistry_questions
    config:
      type: function
      function: data_strategies.commons.select_rows
      function_config:
        conditions:
          is_organic_chemistry: True
    input_ids:
      - organic_chem_questions
  - id: fuzzy_dedup
    config:
      type: cpu_function
      num_cpus: 80
      function: data_strategies.DeepSeekR1.utils.fuzzy_dedup
      function_config:
        column: problem
        similarity_threshold: 95.0
    input_ids:
      -  filter_by_organic_chemistry_questions
  - id: decontaminate
    config:
      type: cpu_function
      num_cpus: 80
      function:  data_strategies.DeepSeekR1.utils.decontaminate_table
      function_config:
        column: problem
        eval_datasets:
          - HuggingFaceH4/MATH-500
          - Maxwell-Jia/AIME_2024
          - AI-MO/aimo-validation-amc
          - livecodebench/code_generation_lite
        eval_columns:
          - problem
          - Problem
          - problem
          - question_content
        eval_splits:
          - test
          - train
          - train
          - test
        similarity_threshold: 95.0
    input_ids:
      - fuzzy_dedup