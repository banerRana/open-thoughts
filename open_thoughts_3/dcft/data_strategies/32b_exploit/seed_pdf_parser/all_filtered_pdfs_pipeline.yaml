operators:
  - id: create_urls
    config:
      type: function
      function: data_strategies.32b_exploit.seed_pdf_parser.utils.create_url_dataset
      function_config:
        urls:
          - "https://uwaterloo.ca/chemistry/sites/default/files/uploads/documents/avogadro-exam-solution-2010.pdf"
          - "https://uwaterloo.ca/chemistry/sites/default/files/uploads/documents/avogadro-exam-solution-2009.pdf"
          - "https://uwaterloo.ca/chemistry/sites/default/files/uploads/documents/avogadro-exam-solution-2008.pdf"
          - "https://uwaterloo.ca/chemistry/sites/default/files/uploads/documents/avogadro-exam-solution-2007.pdf"
          - "https://uwaterloo.ca/chemistry/sites/default/files/uploads/documents/chem-13-news-solution-2011.pdf"
          - "https://uwaterloo.ca/chemistry/sites/default/files/uploads/documents/chem-13-news-exam-solution-2010.pdf"
          - "https://uwaterloo.ca/chemistry/sites/default/files/uploads/documents/chem-13-news-exam-solution-2009.pdf"
          - "https://uwaterloo.ca/chemistry/sites/default/files/uploads/documents/chem-13-news-exam-solution-2008.pdf"
          - "https://uwaterloo.ca/chemistry/sites/default/files/uploads/documents/chem-13-news-exam-solution-2007.pdf"
          - "https://www.press.muni.cz/media/3019066/answers_to_all_questions.pdf"
          - "https://public.wsu.edu/~thorglab/biol301/exams/finalkey.pdf"
          - "https://people.bu.edu/msoren/BI515_2014/Exam1key.pdf"
          - "https://facultystaff.richmond.edu/~lrunyenj/bio201/04bio201%20exam%201%20key.pdf"
          - "https://www.usabo-trc.org/sites/default/files/images/pdf/exams/semifinal-answers/2011-semifinal-answers.pdf"
          - "https://sites.science.oregonstate.edu/chemistry/courses/ch411/restrict2/ch411%20F11%20final%20key%20.pdf"
          - "https://www.mit.edu/~anugrah/files/MockIChOSolutions.pdf"
          - "https://www.mit.edu/~anugrah/files/2012CChOLocalSoln.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2022/11/CCC-PtA-2022-ENG-final-ANSWERS.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2022/12/Canadian-Chemistry-Olympiad-2022-EN_key.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2022/01/CCC-PtA-2021-ENG-ANSWERS.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2021/01/CCC-PtA-2020-ENG-ANSWERS-revised-COVID19.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2019/11/CCC-2019-PtA-answers.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2019/11/CCC-2017-PtA-answers-EN.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2019/11/CCC-2018-PtA-answers-EN.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2019/11/CCC-2016-PtA-answers-EN.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2019/11/CCC-2015-PtA-answers-EN.pdf"
          - "https://www.cheminst.ca/wp-content/uploads/2019/11/CCC-2014-PtA-answers-EN.pdf"
          - "https://www.ttcho.com/_files/ugd/988b76_e3d21fc42bb24de4959d7250f0cfcb3a.pdf"
          - "https://www.ttcho.com/_files/ugd/988b76_01ceeff230b24cbbb0125b2bfa3f3475.pdf"
          - "https://www.ttcho.com/_files/ugd/988b76_48944f6ace684143bfdc9080fca59862.pdf"
          - "https://www.ttcho.com/_files/ugd/988b76_ba0cb3177d05436da273a400a037ed01.pdf"
          - "http://chemistryrace.com/wp-content/uploads/2025/02/ChR_2025_answer_booklet.pdf"
          - "http://chemistryrace.com/wp-content/uploads/2024/02/ChR_2024_answer_booklet.pdf"
          - "http://chemistryrace.com/wp-content/uploads/2023/02/chemistry_race_2023_answers-book.pdf"
          - "http://chemistryrace.com/wp-content/uploads/2022/02/cambridge_chemistry_race_2022_answers.pdf"
          - "http://chemistryrace.com/wp-content/uploads/2021/02/Chemistry_Race_2021_Questions_and_Solutions.pdf"
          - "https://chemistryrace.soc.srcf.net/wp-content/uploads/2020/02/Chemistry_Race_2020_Questions_and_Solutions.pdf"
          - "https://biolympiads.com/wp-content/uploads/2015/01/2003_OpenExam_AnswerKey2.pdf"
          - "http://biolympiads.com/wp-content/uploads/2015/01/2004_OpenExam_AnswerKey4.pdf"
          - "http://biolympiads.com/wp-content/uploads/2015/01/2005_OpenExam_AnswerKey1.pdf"
          - "http://biolympiads.com/wp-content/uploads/2015/01/2006_OpenExam_AnsKey2.pdf"
          - "http://biolympiads.com/wp-content/uploads/2015/01/2007_OpenExam_AnsKey1.pdf"
          - "http://biolympiads.com/wp-content/uploads/2015/01/2008_OpenExam_AnsKey1.pdf"
          - "http://biolympiads.com/wp-content/uploads/2015/01/2009_OpenExam_AnsKey1.pdf"
          - "http://biolympiads.com/wp-content/uploads/2015/01/2010_OpenExam_AnsKey3.pdf"
          - "http://biolympiads.com/wp-content/uploads/2015/01/2011_OpenExam_AnsKey.pdf"
          - "http://biolympiads.com/wp-content/uploads/2015/01/2012_OpenExam_AnsKey2.pdf"
          - "https://www.asi.edu.au/wp-content/uploads/2024/02/ASOE-Chemistry-2023-Exam-Paper-with-Answers.pdf"
          - "https://www.asi.edu.au/wp-content/uploads/2023/05/ASOE-Chemistry-2022-ASDAN-answers.pdf"
          - "https://www.asi.edu.au/wp-content/uploads/2023/05/ASOE_Chemistry_2021_answers_reduced-FS.pdf"
          - "https://www.asi.edu.au/wp-content/uploads/2022/12/2020-asoe-chemistry-exam-answers.pdf"
          - "https://www.asi.edu.au/wp-content/uploads/2022/12/2019-asoe-chemistry-exam-answers.pdf"
          - "https://www.asi.edu.au/wp-content/uploads/2022/12/2018-asoe-chemistry-exam-answers.pdf"
          - "https://www.andrews.edu/~rwright/physics/OpenStax%20Physics-Student%20Solution%20Manual.pdf"
          - "https://reanphysics.wordpress.com/wp-content/uploads/2018/11/raymond_a-_serway_john_w-_jewett_student_solutibookzz-org.pdf"
          - "https://carrollscaveofknowledge.weebly.com/uploads/2/0/2/8/20287891/physics_11_regular_year_solutions_manual.pdf"
          - "https://doctor2019.jumedicine.com/wp-content/uploads/sites/10/2019/09/Giancoli-Physics-Principles-With-Applications-7th-c2014-solutions-ISM.pdf"
  - id: get_pdf_bytes
    config:
      shard: True
      num_shards: 3
      type: function
      function: data_strategies.32b_exploit.seed_pdf_parser.utils.download_pdfs
    input_ids:
      - create_urls
  - id: process_pdfs
    config:
      sharded: True
      num_shards: 3
      type: function
      function: data_strategies.32b_exploit.seed_pdf_parser.utils.get_all_page_counts
    input_ids:
      - get_pdf_bytes
  - id: get_page_bytes
    config:
      type: cpu_function
      num_cpus: 40
      sharded: true
      num_shards: 10
      function: data_strategies.32b_exploit.seed_pdf_parser.utils.expand_and_extract_pages
      function_config:
        page_count_column: page_count
    input_ids:
      - process_pdfs
  - id: drop_columns
    config:
      type: function
      sharded: True
      num_shards: 1
      function: data_strategies.commons.remove_columns
      function_config:
        columns:
          - pdf_bytes
    input_ids:
      - get_page_bytes
  - id: generate_plan_instructions
    config:
      type: completions
      map: gemini_ocr
      map_config:
        pdf_url_column: "url"
        output_extraction_column: "output_extraction"
        page_number_column: "page_number"
      model: "gemini/gemini-2.0-flash-lite-preview-02-05"
      backend_params:
        invalid_finish_reasons: ["content_filter"]
        max_requests_per_minute: 4_000
        max_tokens_per_minute: 4_000_000
    input_ids:
      - drop_columns
  - id: get_question_choices_and_solutions
    config:
      type: completions
      map: chat
      map_config:
        user_message: |
          Extract the questions, answer choices, and solutions from the extracted text from the pdf below.

          Format your response as below:
            QUESTION: "the question from the text and all relevant context excluding the answer and choices" (i.e. if the question is "What was Elvis Presley's (a) favorite sandwich? (b) most hated song? (c) birthday?" You should have a question "QUESTION: What was Elvis Presley's favorite sandwich..." and then another question "QUESTION: What was Elvis Presley's most hated song?..."  etc.)
            ANSWER CHOICES: "answer choice 1" ||| "answer choice 2" ... (if no answer choices are available just say "free response", if answer choices are available please write them out i.e. "A: 0.57 ||| B: John Hancock ||| ..." etc.)
            SOLUTION: "correct answer choice" or "free response answer". If you cannot determine the correct solution say "NO ANSWER DETECTED"

          It is important that each QUESTION: is self contained, meaning, if you were to read "QUESTION: ..." by itself, you should be able to answer it. Given the example "What was Elvis Presley's (a) favorite sandwich? (b) most hated song? (c) birthday?", you should NOT say "QUESTION: favorite sandwich?" as this makes no sense. Instead you should say "QUESTION: What was Elvis Presley's favorite sandwich?"
          To be clear. All questions with subquestions should be restated as individual questions themselves with all relevant information required to answer them.
          Only break up the subquestions.  I.E. only break up questions that have (a) (b) and (c) or (1) (2) and (3), do not break up questions that do not have markers indicating they have parts or subquestions please.
          We are creating a bank of questions that are automatically extracted from pdfs, so it is imperative you get this right.
          ---
          Extracted Text:

          {{output_extraction}}
          """
        output_column: question_choices_solutions
      model: gpt-4o-mini
    input_ids:
      - generate_plan_instructions
  - id: split_qas
    config:
      shard: True
      num_shards: 1
      type: function
      function: data_strategies.32b_exploit.pdf_helper.process_extracted_questions
    input_ids:
      - get_question_choices_and_solutions
  - id: generate_questions_improved
    config:
      type: completions
      map: chat
      map_config:
        user_message: |
          You are an instructor creating exam questions.
          I will provide you with a given question and the text from which it was extracted from.
          You will ensure that the question is answerable, meaning that there is enough context to answer the question.
          To do this, you will look at the extracted text and ensure that nothing is missing from the current questions instantiation. If there is, you will provide the new extra text before restating the question but be sure you always add the question itself at the end.
          Because you are an instructor creating exam questions, you will never include the solution in the extra text or question.

          Here is an example of your task:
          Extracted Question: Calculate the chemical amount (in mol or mmol) of nitric acid that reacts with the
            5.000 g sample of this mineral.
          Extracted Text: A sample of a different mineral is analysed by the same methods. This mineral also contains only Pb2+, CO3 2−, OH− and O2− ions.
            When a 5.000 g sample of this mineral is treated with 25.00 mL of 2.000 mol L−1 nitric acid
            (HNO3), 0.5214 g of carbon dioxide is released, and 0.01051 mol of the acid remains.
            When subjected to thermal decomposition, 5.000 g of this mineral loses 0.5926 g.
            (g) Calculate the chemical amount (in mol or mmol) of nitric acid that reacts with the
            5.000 g sample of this mineral.

          You would tell me:

          A sample of a different mineral is analysed by the same methods. This mineral also contains only Pb2+, CO3 2−, OH− and O2− ions.
            When a 5.000 g sample of this mineral is treated with 25.00 mL of 2.000 mol L−1 nitric acid
            (HNO3), 0.5214 g of carbon dioxide is released, and 0.01051 mol of the acid remains.
            When subjected to thermal decomposition, 5.000 g of this mineral loses 0.5926 g. Calculate the chemical amount (in mol or mmol) of nitric acid that reacts with the
            5.000 g sample of this mineral.

          ---

          Here is the question: {{extracted_question}}
          Here is the extracted text: {{output_extraction}}

          ---

          Do not include any filler like "here is the improved question". Include only the relevant information and the question itself. Include all answer choices if applicable.
          Do not include the solution if you see it. This is an exam, so you should NOT include the final answer in the question.
          """
        output_column: improved_question_solution
      model: gpt-4o-mini
    input_ids:
      - split_qas
  - id: filtered_qas
    config:
      shard: True
      num_shards: 1
      type: function
      function: data_strategies.32b_exploit.pdf_helper.filter_valid_qas
    input_ids:
      - generate_questions_improved
  - id: validate_questions
    config:
      type: completions
      model: gpt-4o-mini
      map: binary_classifier
      map_config:
        user_message: |
          Yes or No, is the question an answerable difficult science, math, or coding question? If the question refers to content (figures, equations, additional text) that you cannot see, then it is unanswerable.
          Provide your reasoning.
          Question:
          {{improved_question_solution}}
        output_column: qa_validation_outputs
      temperature: 0.0  # From stage 1
      top_p: 1.0
      presence_penalty: 0.0
    input_ids:
      - filtered_qas

  - id: filter_by_validation_output
    config:
      type: function
      function: data_strategies.commons.select_rows
      function_config:
        conditions:
          qa_validation_outputs: True
    input_ids:
      - validate_questions
  - id: fuzzy_dedup
    config:
      type: cpu_function
      num_cpus: 80
      function: data_strategies.DeepSeekR1.utils.fuzzy_dedup
      function_config:
        column: improved_question_solution
        similarity_threshold: 95.0
    input_ids:
      - filter_by_validation_output
  - id: decontaminate
    config:
      type: cpu_function
      num_cpus: 80
      function: data_strategies.DeepSeekR1.utils.decontaminate_table
      function_config:
        column: improved_question_solution
        eval_datasets:
          - HuggingFaceH4/MATH-500
          - Maxwell-Jia/AIME_2024
          - AI-MO/aimo-validation-amc
          - livecodebench/code_generation_lite
        eval_columns:
          - problem
          - Problem
          - problem
          - question_content
        eval_splits:
          - test
          - train
          - train
          - test
        similarity_threshold: 95.0
    input_ids:
      - fuzzy_dedup