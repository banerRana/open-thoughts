operators:
  - id: create_urls
    config:
      type: function
      function: data_strategies.32b_exploit.seed_pdf_parser.utils.create_url_dataset
      function_config:
        urls:
        - "https://www.andrews.edu/~rwright/physics/OpenStax%20Physics-Student%20Solution%20Manual.pdf"
        # - "https://biocomp.utoronto.ca/files/2024/05/Exam2024.pdf"
        # - "https://ia801305.us.archive.org/8/items/ProblemsInCalculusOfOneVariableI.A.Maron/Problems%20in%20Calculus%20of%20One%20Variable%20-%20I.%20A.%20Maron.pdf"
        # - "https://www.asi.edu.au/wp-content/uploads/2024/02/ASOE-Chemistry-2023-Exam-Paper.pdf"
        # - "https://www.asi.edu.au/wp-content/uploads/2023/05/ASOE-Chemistry-2022-ASDAN-questions-only.pdf" 
  - id: get_pdf_bytes
    config:
      shard: True
      num_shards: 1
      type: function
      function: data_strategies.32b_exploit.seed_pdf_parser.utils.download_pdfs
    input_ids:
      - create_urls
  - id: process_pdfs
    config:
      sharded: True
      num_shards: 1
      type: async_function
      num_shards: 2
      sharded: True
      function: data_strategies.32b_exploit.seed_pdf_parser.utils.download_pdfs
    input_ids:
      - get_pdf_bytes
  - id: get_page_bytes
    config:
      type: cpu_function
      num_cpus: 40
      sharded: true
      num_shards: 1
      function: data_strategies.32b_exploit.seed_pdf_parser.utils.expand_and_extract_pages
      function_config:
        page_count_column: page_count
    input_ids:
      - process_pdfs
  - id: drop_columns
    config:
      type: function
      sharded: True
      num_shards: 1
      function: data_strategies.commons.remove_columns
      function_config:
        columns:    
          - pdf_bytes
    input_ids:
      - get_page_bytes
  - id: generate_plan_instructions
    config:
      type: cpu_function
      num_cpus: 1
      function: data_strategies.32b_exploit.seed_pdf_parser.utils.process_pdfs
      sharded: True
      num_shards: 2
    input_ids:
<<<<<<< HEAD
      - download_pdfs
  - id: generate_plan_instructions
    config:
      type: completions
      map: list_qa
      map_config:
        user_message: |
          Extract all of the questions and answer choices from the following text. 
          If a question references an image or content not found in the text, ignore it.
          Capture all relevant context for each question.

          {chunk}}
          """
        output_instruction_column: extracted_question
        output_response_column: extracted_response
      model: gpt-4o-mini
      temperature: 0.99
    input_ids:
      -  generate_plan_instructions
  - id: generate_questions_improved
    config:
      type: completions
      map: chat
      map_config:
        user_message: |
          I will provide you with a given question and the text from which it was extracted from.
          Provide the text before the question in the extracted text that is useful for answering the question and the question itself. 
=======
      - drop_columns
  - id: generate_questions
    config:
      type: completions
      map: list_qa
      map_config:
        user_message: |
          Extract all of the questions and answer choices from the following text. 
          If a question references an image or content not found in the text, ignore it.
          Capture all relevant context for each question.

<<<<<<< HEAD
  #         {{output_extraction}}
  #         """
  #       output_instruction_column: extracted_question
  #       output_response_column: extracted_response
  #     model: gpt-4o-mini
  #   input_ids:
  #     -  generate_plan_instructions
  # - id: generate_questions_improved
  #   config:
  #     type: completions
  #     map: chat
  #     map_config:
  #       user_message: |
  #         I will provide you with a given question and the text from which it was extracted from.
  #         Provide the text before the question in the extracted text that is useful for answering the question and the question itself. 
>>>>>>> ba3719d8 (working pipeline)
=======
          {{output_extraction}}
          """
        output_instruction_column: extracted_question
        output_response_column: extracted_response
      model: gpt-4o-mini
    input_ids:
      -  generate_plan_instructions
  - id: generate_questions_improved
    config:
      type: completions
      map: chat
      map_config:
        user_message: |
          I will provide you with a given question and the text from which it was extracted from.
          Provide the text before the question in the extracted text that is useful for answering the question and the question itself. 
>>>>>>> 190f5d9a (added finalized pipeline)

          For example: 
          Extracted Question: Calculate the chemical amount (in mol or mmol) of nitric acid that reacts with the
            5.000 g sample of this mineral.
          Extracted Text: A sample of a different mineral is analysed by the same methods. This mineral also contains only Pb2+, CO3 2−, OH− and O2− ions.
            When a 5.000 g sample of this mineral is treated with 25.00 mL of 2.000 mol L−1 nitric acid
            (HNO3), 0.5214 g of carbon dioxide is released, and 0.01051 mol of the acid remains.
            When subjected to thermal decomposition, 5.000 g of this mineral loses 0.5926 g.
            (g) Calculate the chemical amount (in mol or mmol) of nitric acid that reacts with the
            5.000 g sample of this mineral. 

          You would tell me: 

          A sample of a different mineral is analysed by the same methods. This mineral also contains only Pb2+, CO3 2−, OH− and O2− ions.
            When a 5.000 g sample of this mineral is treated with 25.00 mL of 2.000 mol L−1 nitric acid
            (HNO3), 0.5214 g of carbon dioxide is released, and 0.01051 mol of the acid remains.
            When subjected to thermal decomposition, 5.000 g of this mineral loses 0.5926 g. Calculate the chemical amount (in mol or mmol) of nitric acid that reacts with the
            5.000 g sample of this mineral. 

<<<<<<< HEAD
<<<<<<< HEAD
=======
>>>>>>> 190f5d9a (added finalized pipeline)
          Here is the question: {{extracted_question}}
          Here is the extracted text: {{output_extraction}}

          Do not include any filler like "here is the improved question". Include only the relevant information and the question itself.           
          """
        output_column: improved_question
      model: gpt-4o-mini
    input_ids:
<<<<<<< HEAD
      - generate_questions
=======
  #         Here is the question: {{extracted_question}}
  #         Here is the extracted text: {{output_extraction}}
  #         """
  #       output_column: improved_question
  #     model: gpt-4o-mini
  #   input_ids:
  #     - generate_questions
>>>>>>> ba3719d8 (working pipeline)
=======
      - generate_questions
>>>>>>> 190f5d9a (added finalized pipeline)
