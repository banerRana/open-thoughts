operators:
  - id: load_seed_code
    config:
      type: load_preexisting
      framework_name: workinprogress__raw_parsed_pdfs_for_verifiable_qa
  - id: filtered_qas
    config:
      shard: True
      num_shards: 1
      type: function
      function: data_strategies.32b_exploit.pdf_helper.filter_valid_qas
    input_ids:
      - load_seed_code
  - id: validate_questions
    config:
      type: completions
      model: gpt-4o-mini
      map: binary_classifier
      map_config:
        user_message: |
          Yes or No, is the question an answerable difficult science, math, or coding question? If the question refers to content (figures, equations, additional text) that you cannot see, then it is unanswerable.
          Provide your reasoning.
          Question:
          {{improved_question_solution}}
        output_column: qa_validation_outputs
      temperature: 0.0  # From stage 1
      top_p: 1.0
      presence_penalty: 0.0
    input_ids:
      - filtered_qas

  - id: filter_by_validation_output
    config:
      type: function
      function: data_strategies.commons.select_rows
      function_config:
        conditions:
          qa_validation_outputs: True
    input_ids:
      - validate_questions
  - id: fuzzy_dedup
    config:
      type: cpu_function
      num_cpus: 80
      function: data_strategies.DeepSeekR1.utils.fuzzy_dedup
      function_config:
        column: improved_question_solution
        similarity_threshold: 95.0
    input_ids:
      -  filter_by_validation_output
  - id: decontaminate
    config:
      type: cpu_function
      num_cpus: 80
      function:  data_strategies.DeepSeekR1.utils.decontaminate_table
      function_config:
        column: improved_question_solution
        eval_datasets:
          - HuggingFaceH4/MATH-500
          - Maxwell-Jia/AIME_2024
          - AI-MO/aimo-validation-amc
          - livecodebench/code_generation_lite
        eval_columns:
          - problem
          - Problem
          - problem
          - question_content
        eval_splits:
          - test
          - train
          - train
          - test
        similarity_threshold: 95.0
    input_ids:
      - fuzzy_dedup